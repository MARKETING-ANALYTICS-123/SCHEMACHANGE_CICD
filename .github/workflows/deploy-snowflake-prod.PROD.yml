name: Snowflake CI/CD Deploy (PROD)

on:
  push:
    branches:
      - PROD

jobs:
  detect-and-deploy:
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.set-projects.outputs.projects }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - id: set-projects
        shell: bash
        run: |
          git fetch origin PROD --depth=2
          PREV_COMMIT=$(git rev-parse HEAD^)
          changed_files=$(git diff --name-only $PREV_COMMIT HEAD | grep '\.sql$' || true)

          if [ -z "$changed_files" ]; then
            echo "No changed .sql files."
            echo "projects=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          projects=$(echo "$changed_files" | awk -F/ '{print $2}' | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "Projects detected: $projects"
          echo "projects=$projects" >> $GITHUB_OUTPUT

      - name: Deploy per project
        uses: actions/github-script@v6
        with:
          script: |
            const projects = JSON.parse(process.env.PROJECTS || '[]');
            if (projects.length === 0) {
              console.log('No projects to deploy.');
              return;
            }
            for (const project of projects) {
              console.log(`Would deploy for project: ${project}`);
              // Here, you would trigger your deployment steps per project,
              // e.g., call a reusable workflow or run deployment scripts.
            }
        env:
          PROJECTS: ${{ steps.set-projects.outputs.projects }}
