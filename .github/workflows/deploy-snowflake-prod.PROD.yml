name: Snowflake CI/CD Deploy (PROD)

on:
  push:
    branches:
      - PROD

jobs:
  detect-projects:
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.set-projects.outputs.projects }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - id: set-projects
        shell: bash
        run: |
          git fetch origin PROD --depth=2
          PREV_COMMIT=$(git rev-parse HEAD^)
          changed_files=$(git diff --name-only $PREV_COMMIT HEAD | grep '\.sql$' || true)

          if [ -z "$changed_files" ]; then
            echo "No changed .sql files."
            echo "projects=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          projects=$(echo "$changed_files" | awk -F/ '{print $2}' | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "Projects detected: $projects"
          echo "projects=$projects" >> $GITHUB_OUTPUT

  deploy:
    needs: detect-projects
    runs-on: ubuntu-latest
    if: needs.detect-projects.outputs.projects != '[]'
    strategy:
      matrix:
        project: ${{ fromJson(needs.detect-projects.outputs.projects) }}
    steps:
      - run: echo "Deploying project ${{ matrix.project }}"
