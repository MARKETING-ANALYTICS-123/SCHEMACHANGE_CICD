name: Deploy Changed SQL Files

on:
  push:
    branches:
      - main
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Ensures all commits are available

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          pip install snowflake-connector-python cryptography

      - name: Detect Changed Project and Files
        id: detect
        run: |
          echo "Changed files since last commit:"
          git diff --name-only HEAD~1 HEAD
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '^dbscripts2/' | tr '\n' ',')
          echo "CHANGED_FILES=$CHANGED_FILES" >> $GITHUB_ENV

          # Extract project name
          PROJECT=$(echo "$CHANGED_FILES" | cut -d'/' -f2 | head -n1)
          echo "Detected project: $PROJECT"
          echo "PROJECT=$PROJECT" >> $GITHUB_ENV

      - name: Deploy SQL Files
        env:
          PROJECT: ${{ env.PROJECT }}
          PRIVATE_KEY: ${{ secrets[format('{0}_PRIVATE_KEY', env.PROJECT)] }}
          CHANGED_FILES: ${{ env.CHANGED_FILES }}
        run: |
          echo "Running deployment for project: $PROJECT"
          python deploy_sql_files.py
